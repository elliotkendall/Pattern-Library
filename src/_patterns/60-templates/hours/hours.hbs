{{assign 'now' (lowercase (formatDate today 'dddd') )}}

{{! Loop through each location added to the page }}
{{#each locations}}
  {{!-- {{assign 'semester-hours.exceptions' semester-hours.exceptions.exception}} --}}
  {{assign 'heading' location}}

  {{! Loop through the location's semester hours and capture the property's name }}  
  {{assign 'semester-hours' (arrayify semester-hours)}}
  {{#each semester-hours}}
      {{! Check if the semester is current }}    
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}

      {{#each this as |value key|}}

        {{!-- {{{_inspect exceptions}}} --}}

          {{! Transform AM/PM to a.m./p.m. to match AP Style Guide}}
          {{#if (eq open.am-pm 'AM')}}
            {{assign 'open.am-pm' 'a.m.'}}
          {{else if (eq open.am-pm 'PM')}}
            {{assign 'open.am-pm' 'p.m.'}}
          {{/if}}

          {{#if (eq close.am-pm 'AM')}}
            {{assign 'close.am-pm' 'a.m.'}}
          {{else if (eq close.am-pm 'PM')}}
            {{assign 'close.am-pm' 'p.m.'}}
          {{/if}}
          
          {{#if (eq @key ../../../now) }}
          
            {{!-- {{{_inspect exceptions}}} --}}

            {{! Check against exceptions }}
            <p>Today is {{capitalize @key}}</p>

            {{#each ../exceptions.exception}}
              {{storageGet 'day'}}
              {{{_inspect start-date}}}
              {{{_inspect end-date}}}
              <p>The exception start date is the same or before today? {{momentIsSameOrBeforeToday start-date}}</p>
              
              <p>The exception end date is the same or after today? {{momentIsSameOrBeforeToday start-date}}</p>
              {{and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date) }}
              {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date) )}}
                {{#if (eq type 'Closed')}}
                  <p>Closed</p>
                {{else}}
                  {{#with @value}}
                    <p>Today's Hours: {{#with open}} {{combine hour ':' minute ' ' am-pm}} {{/with}}–{{#with close}} {{combine hour ':' minute ' ' am-pm}}{{/with}}</p>
                  {{/with}}
                {{/if}}
              {{else}}
                {{#with @value}}
                  <p>Today's Hours: {{#with open}} {{combine hour ':' minute ' ' am-pm}} {{/with}}–{{#with close}} {{combine hour ':' minute ' ' am-pm}}{{/with}}</p>
                {{/with}}
              {{/if}}
            {{/each}}
          {{/if}}

      {{/each}}
    {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}

      {{! Run only through properties that are days of the week to find tomorrow }}
      
        {{#if (eq @key (lowercase (momentAddDays 1)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

    {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}


        {{#if (eq @key (lowercase (momentAddDays 2)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

    {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}

         {{#if (eq @key (lowercase (momentAddDays 3)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

    {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}


        {{#if (eq @key (lowercase (momentAddDays 4)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

    {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}

        {{#if (eq @key (lowercase (momentAddDays 5)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

    {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}


        {{#if (eq @key (lowercase (momentAddDays 6)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

      {{/if}}
  {{/each}}

  {{#each semester-hours as |value key|}}

    {{! Check if the semester is current }}
    {{#if (and (momentIsSameOrBeforeToday start-date) (momentIsSameOrAfterToday end-date))}}

        {{#if (eq @key (lowercase (momentAddDays 7)))}}

          {{#with @value}}
            <p>{{capitalize @key}}: {{combine open.hour ':' open.minute ' ' open.am-pm}} – {{combine close.hour ':' close.minute ' ' close.am-pm}}</p>
          {{/with}}

        {{/if}}

      {{/if}}
  {{/each}}

{{/each}}

<div class="hours-page">
  <header class="hours-page-header"></header>
  <div class="hours-page-main">

    {{#extend 'organisms-main' type='hours-page' classes='hours-page-main'}}
      {{#content 'section-main-body'}}
        {{> atoms-table}}
      {{/content}}
    {{/extend}}

  </div>
  <footer class="hours-page-footer"></footer>
</div>
